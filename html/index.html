<!DOCTYPE html>
<html>
	<head lang="ko">
		<meta charset="utf-8">
		<title>Really Fine?</title>
		<link rel="stylesheet" type="text/css" href="css/index.css"/>
		<script src="js/jquery-3.4.0.js"></script>
		<script src="js/d3.js"></script>
		<script src="http://d3js.org/topojson.v1.min.js"></script>
		<script type="text/javascript">
			$(document).ready(function(){
				$(function(){
					
					$("#header").load("logo.html");
				});
		
				$.get("php/getNav.php", function(data){
					$("#nav").append(data);
				});

				$.get("php/getAside.php?RFmenu=900", function(data){
					$("#aside").append(data);
				});
				
				korea_map();
			});
		</script>
	</head>

	<body>
		<header id="header"></header>

		<nav id="nav"></nav>

		<aside id="aside">
		</aside>
		
		<section id="section">
			<article id="article_intro">
				<h1>Really Fine?</h1>
				<p id="introduce">Really Fine?은 에어코리아에서 제공되는 실시간 미세먼지 관측 데이터와 AWS에서 제공되는 실시간 풍향 데이터를 확인하거나 두 데이터간의 상관관계 및 풍향별 미세먼지 데이터의 예측 수치를 확인할 수 있는 시스템입니다.</p>
			</article>
			
			<article id="article_view">
				<div id="view_left">
					<!--<img src="images/fine_dust.PNG">-->
					<img src="images/wind_rose.PNG">
				</div>

				<div id="view_map">
				</div>

				<div id="view_mytown">
					<div id="mytown_banner">
						<p id="mytown_time">2019-11-21</p>
						<p id="mytown_pm">미세먼지(PM10)</p>
						<p id="mytown_titleL">우리동네</p>
						<p id="mytown_titleR">대기정보</p>
						<p id="mytown_loc">상당구</p>
					</div>

					<div id="mytown_view">
						<table id="mytown_table">테이블</table>
						<div id="mytown_graph">그래프</div>
					</div>
				</div>
			</article>
	
			<article id="article_site">
				<a href="http://www.keco.or.kr"><img src="images/site01.jpg"></a>
				<a href="http://www.me.go.kr"><img src="images/site02.jpg"></a>
				<a href="http://www.weather.go.kr"><img src="images/site03.jpg"></a>
				<a href="https://air.incheon.go.kr/"><img src="images/site04.jpg"></a>
				<a href="http://cleanair.seoul.go.kr/main.htm"><img src="images/site05.jpg"></a>
				<a href="http://www.me.go.kr/cleanair"><img src="images/site06.jpg"></a>
			</article>
		</section>
		
		<footer id="footer">
			<img src="images/web_logo.PNG">
			<p><b>Copyright @ minsookim. All rights reserved.</b></p>
		</footer>

		<script>
			// 공공 데이터 요청 [python3]
			// json 형태로 저장 [fine_dust_mss.json]
			// korea map() 작성 
			// 기능 - d3.js의 geo를 사용해서 한국 지도 그림
			// provinces를 사용 나머지는 너무 세세해서 좀 보기 힘듦
			// mss_spot_on_map() 작성
			// mss.json에서 가져온 데이터를 이용해서 점을 찍을 예정인데 값에 따라 
			// 색의 변화를 줄 꺼

			function korea_map(){
				var korea_province = 'skorea_provinces_2018_geo';
				var width = 1024, height = 1024, centered;
				var projection, path, svg, map, geojson, features, bounds, center;
				
				var SPECIAL_CITIES = ['서울특별시', '인천광역시', '대전광역시', '대구광역시', '부산광역시', '울산광역시', '광주광역시', '세종특별자치시', '제주특별자치도'];
				projection = d3.geoMercator().translate( [width /3, height /3] );
				path = d3.geoPath().projection(projection);
				
				svg = d3.select("#view_map").append("svg")
					.attr("width", width)
					.attr("height", height);
				
				map = svg.append("g").attr("id", "map");

				d3.json("data/skorea-provinces-2018-topo.json").then(function(pro_d){
					geojson = topojson.feature(pro_d, pro_d.objects[ korea_province] );
					features = geojson.features;
					
					bounds = d3.geoBounds(geojson);
					center = d3.geoCentroid(geojson);

					var distance = d3.geoDistance( bounds[0], bounds[1] );
					
					projection.scale(6000).center(center);
					
					map.selectAll("path").data(features).enter()
						.append("path")
						.attr("class", function(local){
							return "provinces " + local.properties.code;
						})
						.attr("d", path)
						.on("click", map_clicked);

					spoting_on_map(projection, path, map, svg);
				});

				function spoting_on_map(projection, path, map, svg){
					d3.json("data/fine_dust_mss.json").then(function(spot_d){
						//console.log("spot_d : ",spot_d);
						//console.log("spot_d.list : ", spot_d.list);
						//console.log("in map : ", map);
						//console.log("in pro : ", projection);
						var list_data = spot_d.list;
						var circles = map.selectAll("circle")
						.data(list_data).enter()
						.append("circle")
						.attr("class", function(d){
							/*
							var php_url = "php/getGrade.php?name=" + d.stationName;
							var result;
							$.ajax({
								url: php_url,
								dataType:"text",
								async:false,
								success:function(data){
									result = data;
								}
							});
							console.log(result);
							return result;
							*/
							return "GradeN";
						})
						.attr("cx", function(d){
							//console.log("cx : ", d);
							return projection([d.dmY, d.dmX])[0];
						})
						.attr("cy", function(d){
							//console.log("cy : ", d);
							return projection([d.dmY, d.dmX])[1];
						})
						.attr("r", "2px")
						.attr("fill", "red")
						.transition()
						.ease(d3.easeElastic);
					});
				}
	
				function map_clicked(d){
					var x, y, zoomLevel;
	
					if(d && centered != d){
						var centroid = path.centroid(d);
						x = centroid[0];
						y = centroid[1];
						
						if(d.properties.name == '제주특별자치도' || d.properties.name == '인천광역시')
							zoomLevel = 10;
						else if( SPECIAL_CITIES.indexOf( d.properties.name) != -1)
							zoomLevel = 15;
						else
							zoomLevel = 3;
							centered = d;
							console.log('centered', centered);
					}else{
						x = width / 2;
						y = height / 2;
						zoomLevel = 1;
						centered = null;
					}
	 				
					console.log(map.selectAll("path")
					.classed("click_spot", centered && function(d){
						console.log(d === centered);
						return d === centered;
					}));
	 
					map.transition()
					.duration(2000)
					.attr( "transform", "translate(" + width / 2 + "," + height / 2 + ")scale(" + zoomLevel + ")translate(" + -x + "," + -y + ")")
					.style( "stroke-width", 1.5 / zoomLevel + "px");
				}
			}
			</script>
		</body>
</html>
